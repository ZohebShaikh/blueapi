include:
  - ../../example-services/compose.yaml

services:
  numtracker:
    image: ghcr.io/diamondlightsource/numtracker:1.0.1
    ports:
      - "8406:8000"

  rabbitmq:
    image: docker.io/rabbitmq:4.0-management
    ports:
      - "5672:5672"
      - "15672:15672"
      - "61613:61613"
    volumes:
      - type: bind
        source: ./services/rabbitmq_plugins
        target: /etc/rabbitmq/enabled_plugins

  tiled:
    image: ghcr.io/zohebshaikh/tiled:0.3.1
    ports:
      - "8407:8000"
    environment:
      - TILED_SINGLE_USER_API_KEY=${TILED_SINGLE_USER_API_KEY}
    volumes:
      - ./services/tiled_config:/deploy/config
    depends_on:
      keycloak:
        condition: service_healthy

  keycloak:
    image: keycloak/keycloak:26.4
    environment:
      - KC_BOOTSTRAP_ADMIN_PASSWORD=admin
      - KC_BOOTSTRAP_ADMIN_USERNAME=admin
      - KC_HEALTH_ENABLED=true
      - KC_METRICS_ENABLED=true
    command: ["start-dev"]
    post_start:
      - command: /tmp/startup.sh
    volumes:
      - type: bind
        source: ./services/keycloak/startup.sh
        target: /tmp/startup.sh
    ports:
      - 8090:8080
      - 9000:9000
    healthcheck:
      test: "curl --head -fsS http://localhost:9000/health/ready"
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 12s

  opa:
    network_mode: host
    image: docker.io/openpolicyagent/opa:1.11.0-dev
    ports:
      - 8181:8181
    environment:
      - ISSUER=http://localhost:8090/realms/master
    command: [
        "run",
        "--server",
        "--addr",
        "0.0.0.0:8181",
        "--config-file",
        "/etc/opa-config/config.yaml",
      ]
    volumes:
      - type: bind
        source: ./services/opa-config
        target: /etc/opa-config
